# å‘å¸ƒ Python åŒ…åˆ° PyPI å’Œ GitHub Packages
# æ­¤æ–‡ä»¶åŸºäºŽåŽŸæœ‰çš„ release-pypi.yml ä¿®æ”¹ï¼Œæ·»åŠ äº† GitHub Packages æ”¯æŒ

name: Release Python Package to PyPI and GitHub Packages

on:
  push:
    tags:
      - 'v[0-9]+.*'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (build only, no upload)'
        type: boolean
        default: false
        required: false

env:
  # åˆ¤æ–­æ˜¯å¦ä¸ºæµ‹è¯•æ¨¡å¼
  IS_TEST_MODE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.test_mode == 'true' || github.repository != 'sgl-project/sglang' }}
  # åˆ¤æ–­æ˜¯å¦åº”è¯¥ä¸Šä¼ 
  SHOULD_UPLOAD: ${{ github.repository == 'sgl-project/sglang' && (github.event_name != 'workflow_dispatch' || github.event.inputs.test_mode == 'false') }}

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: "prod"
    permissions:
      contents: read
      packages: write  # éœ€è¦æ­¤æƒé™æ¥å‘å¸ƒåˆ° GitHub Packages
    
    steps:
      - name: Check execution mode
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Is test mode: ${{ env.IS_TEST_MODE }}"
          echo "Should upload: ${{ env.SHOULD_UPLOAD }}"
          echo ""
          if [ "${{ env.IS_TEST_MODE }}" = "true" ]; then
            echo "âš ï¸  RUNNING IN TEST MODE - No actual upload will be performed"
            echo "   This is either because:"
            echo "   1. Manual trigger with test_mode=true"
            echo "   2. Not in the production repository (sgl-project/sglang)"
          else
            echo "âœ… RUNNING IN PRODUCTION MODE - Uploads will be performed"
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for setuptools-scm to determine version from tags

      - name: Build Python package
        run: |
          cd python
          cp ../README.md ../LICENSE .
          pip install build wheel setuptools setuptools-scm
          python3 -m build
          
          # åˆ—å‡ºæž„å»ºçš„åŒ…
          echo "=== Built packages ==="
          ls -lh dist/
          echo "======================"

      - name: Upload to PyPI (conditional)
        if: env.SHOULD_UPLOAD == 'true'
        env:
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          cd python
          pip install twine
          echo "âœ… Uploading to PyPI..."
          python3 -m twine upload dist/* -u __token__ -p $PYPI_TOKEN --verbose

      - name: Skip PyPI upload (test mode)
        if: env.SHOULD_UPLOAD != 'true'
        run: |
          echo "â­ï¸  Skipping PyPI upload (test mode or not production repository)"
          echo "To actually upload, ensure:"
          echo "1. Repository is sgl-project/sglang"
          echo "2. Not in test mode (test_mode=false)"
          echo "3. PYPI_TOKEN secret is configured"

      - name: Upload to GitHub Packages (conditional)
        if: env.SHOULD_UPLOAD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd python
          pip install twine
          
          echo "âœ… Uploading to GitHub Packages..."
          
          # æ–¹æ³•1ï¼šä½¿ç”¨ repository-url å‚æ•°ï¼ˆæŽ¨èï¼‰
          python3 -m twine upload \
            --repository-url https://upload.pkg.github.com/${{ github.repository_owner }}/${{ github.event.repository.name }} \
            dist/* \
            --verbose \
            --username ${{ github.actor }} \
            --password $GITHUB_TOKEN

      - name: Skip GitHub Packages upload (test mode)
        if: env.SHOULD_UPLOAD != 'true'
        run: |
          echo "â­ï¸  Skipping GitHub Packages upload (test mode or not production repository)"
          echo "To actually upload, ensure:"
          echo "1. Repository is sgl-project/sglang"
          echo "2. Not in test mode (test_mode=false)"
          echo "3. Repository has packages write permission"

      - name: Test upload simulation
        if: env.SHOULD_UPLOAD != 'true'
        run: |
          echo "ðŸ§ª TEST MODE - Simulating upload commands"
          echo ""
          echo "PyPI upload command would be:"
          echo "twine upload dist/* -u __token__ -p \$PYPI_TOKEN"
          echo ""
          echo "GitHub Packages upload command would be:"
          echo "twine upload --repository-url https://upload.pkg.github.com/${{ github.repository_owner }}/${{ github.event.repository.name }} dist/* --username ${{ github.actor }} --password \$GITHUB_TOKEN"
          echo ""
          echo "Packages built:"
          cd python && ls -la dist/

      - name: Verify configuration
        run: |
          echo "=== Configuration Verification ==="
          echo "Repository: ${{ github.repository }}"
          echo "Expected production repository: sgl-project/sglang"
          echo "Workflow permissions:"
          echo "  - contents: read âœ…"
          echo "  - packages: write âœ…"
          echo ""
          echo "Secrets configured:"
          if [ -n "${{ secrets.PYPI_TOKEN }}" ]; then
            echo "  - PYPI_TOKEN: âœ… (exists)"
          else
            echo "  - PYPI_TOKEN: âŒ (missing)"
          fi
          if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "  - GITHUB_TOKEN: âœ… (auto-provided)"
          else
            echo "  - GITHUB_TOKEN: âŒ (unexpected)"
          fi
          echo ""
          echo "Next steps:"
          if [ "${{ github.repository }}" != "sgl-project/sglang" ]; then
            echo "1. To test actual upload, run in the production repository"
          elif [ "${{ env.IS_TEST_MODE }}" = "true" ]; then
            echo "1. To perform actual upload, run workflow with test_mode=false"
          else
            echo "1. All checks passed - uploads should proceed"
          fi
          echo "===================="

# é…ç½®è¯´æ˜Žï¼š
# 1. æ­¤å·¥ä½œæµåœ¨åŽŸæœ‰ release-pypi.yml åŸºç¡€ä¸Šæ·»åŠ äº† GitHub Packages æ”¯æŒ
# 2. éœ€è¦ç¡®ä¿ä»“åº“è®¾ç½®ä¸­å¯ç”¨äº† GitHub Packages åŠŸèƒ½
# 3. éœ€è¦æ·»åŠ  permissions é…ç½®ä»¥å…è®¸å†™å…¥ packages
# 4. ä½¿ç”¨ GITHUB_TOKEN è‡ªåŠ¨è®¤è¯ï¼Œæ— éœ€é¢å¤–é…ç½®
# 5. åŒ…å°†åŒæ—¶å‘å¸ƒåˆ° PyPI å’Œ GitHub Packages

# ä½¿ç”¨å‰å‡†å¤‡ï¼š
# 1. ç¡®ä¿å·²é…ç½® PyPI_TOKEN secret
# 2. GITHUB_TOKEN ä¼šè‡ªåŠ¨æä¾›ï¼Œæ— éœ€é…ç½®
# 3. æµ‹è¯•æ—¶å¯ä»¥ä½¿ç”¨ workflow_dispatch æ‰‹åŠ¨è§¦å‘

# æµ‹è¯•å®‰è£…ï¼š
# ä»Ž GitHub Packages å®‰è£…ï¼š
# pip install --index-url https://pkg.github.com/sgl-project/sglang/simple sglang
#
# æˆ–é…ç½® pip ä½¿ç”¨å¤šä¸ªç´¢å¼•ï¼š
# cat > ~/.pip/pip.conf << EOF
# [global]
# extra-index-url = https://pkg.github.com/sgl-project/sglang/simple
# EOF

# æ³¨æ„äº‹é¡¹ï¼š
# 1. GitHub Packages çš„ Python ä»“åº“ä½¿ç”¨ upload.pkg.github.com ä¸Šä¼ 
# 2. å®‰è£…æ—¶ä½¿ç”¨ pkg.github.com/OWNER/REPO/simple
# 3. åŒ…åç§°ä¼šè‡ªåŠ¨ä»Ž pyproject.toml æˆ– setup.py ä¸­è¯»å–
# 4. ç‰ˆæœ¬å·ä»Ž git æ ‡ç­¾è‡ªåŠ¨æå–
# 5. å¦‚æžœå‘å¸ƒå¤±è´¥ï¼Œæ£€æŸ¥æƒé™å’Œç½‘ç»œè¿žæŽ¥