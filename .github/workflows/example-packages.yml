# SGLang 项目 GitHub Packages 配置指南
# 此文件提供了针对 sglang 项目的具体配置建议，用于发布到 GitHub Packages

name: SGLang - GitHub Packages Configuration Guide

on:
  workflow_dispatch:   # 仅用于手动触发，作为配置参考

jobs:
  # 配置指南 - 不执行实际构建，仅展示配置示例
  configuration-guide:
    runs-on: ubuntu-latest
    steps:
      - name: 显示配置指南
        run: |
          echo "=========================================="
          echo "SGLang 项目 GitHub Packages 配置指南"
          echo "=========================================="
          echo ""
          echo "1. Docker 镜像发布到 GitHub Container Registry (ghcr.io)"
          echo "=========================================="
          echo "修改现有的 release-docker.yml 文件，添加以下内容："
          echo ""
          echo "a. 在 jobs 部分添加 permissions:"
          echo "   permissions:"
          echo "     contents: read"
          echo "     packages: write"
          echo ""
          echo "b. 在登录 Docker Hub 的步骤后添加登录 GitHub Container Registry:"
          echo "   - name: Login to GitHub Container Registry"
          echo "     uses: docker/login-action@v2"
          echo "     with:"
          echo "       registry: ghcr.io"
          echo "       username: \${{ github.actor }}"
          echo "       password: \${{ secrets.GITHUB_TOKEN }}"
          echo ""
          echo "c. 修改构建命令，添加 ghcr.io 标签:"
          echo "   在现有的 docker buildx build 命令中，添加额外的 -t 参数:"
          echo "   -t ghcr.io/sgl-project/sglang:\${tag}"
          echo ""
          echo "d. 在 create-manifests 作业中添加 ghcr.io 的多架构清单创建"
          echo ""
          echo "2. Python 包发布到 GitHub Packages"
          echo "=========================================="
          echo "修改现有的 release-pypi.yml 文件，添加以下步骤："
          echo ""
          echo "a. 在 Upload to pypi 步骤前添加权限配置:"
          echo "   permissions:"
          echo "     contents: read"
          echo "     packages: write"
          echo ""
          echo "b. 添加发布到 GitHub Packages 的步骤:"
          echo "   - name: Publish to GitHub Packages"
          echo "     env:"
          echo "       TWINE_USERNAME: \${{ github.actor }}"
          echo "       TWINE_PASSWORD: \${{ secrets.GITHUB_TOKEN }}"
          echo "     run: |"
          echo "       python3 -m twine upload \\"
          echo "         --repository-url https://ghcr.io/\${{ github.repository }}/python \\"
          echo "         dist/* \\"
          echo "         --verbose"
          echo ""
          echo "3. 具体文件修改示例"
          echo "=========================================="
          echo "已创建以下参考文件："
          echo "1. release-docker-with-ghcr.yml - Docker 发布到双注册表的完整示例"
          echo "2. release-pypi-with-ghpkg.yml - Python 包发布到双仓库的示例"
          echo ""
          echo "4. 仓库设置要求"
          echo "=========================================="
          echo "1. 确保仓库 Settings → Actions → General 中："
          echo "   - Workflow permissions 设置为 'Read and write permissions'"
          echo "   - 勾选 'Allow GitHub Actions to create and approve pull requests'"
          echo ""
          echo "2. 确保 GitHub Packages 功能已启用（默认启用）"
          echo ""
          echo "3. 访问发布的包："
          echo "   - Docker 镜像: https://ghcr.io/sgl-project/sglang"
          echo "   - Python 包: https://github.com/sgl-project/sglang/packages"
          echo ""
          echo "5. 测试建议"
          echo "=========================================="
          echo "1. 先使用 workflow_dispatch 手动触发测试"
          echo "2. 查看 Actions 日志确认无错误"
          echo "3. 验证包在 GitHub Packages 页面可见"
          echo "4. 测试从 ghcr.io 拉取镜像或安装 Python 包"
          echo ""
          echo "注意：实际生产使用时应将配置集成到现有工作流中，而非创建新文件。"

  # 实际配置示例 - 可根据需要取消注释使用
  # docker-example:
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     packages: write
  #   if: false  # 默认禁用，仅作为示例
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     
  #     - name: Login to GHCR
  #       uses: docker/login-action@v2
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #     
  #     - name: Build and push test image
  #       run: |
  #         docker build -t ghcr.io/${{ github.repository }}/test:latest -f docker/Dockerfile .
  #         docker push ghcr.io/${{ github.repository }}/test:latest

  # python-example:
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     packages: write
  #   if: false  # 默认禁用，仅作为示例
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.10'
  #     
  #     - name: Build test package
  #       run: |
  #         cd python
  #         pip install build
  #         python -m build
  #     
  #     - name: Publish to GitHub Packages
  #       env:
  #         TWINE_USERNAME: ${{ github.actor }}
  #         TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         cd python
  #         pip install twine
  #         python -m twine upload \
  #           --repository-url https://ghcr.io/${{ github.repository }}/python \
  #           dist/*

# 使用说明：
# 此工作流主要作为配置指南，实际使用时：
# 1. 将上述配置建议应用到现有的 release-docker.yml 和 release-pypi.yml 文件中
# 2. 或直接使用已创建的参考文件（重命名后使用）
# 3. 测试通过后，可删除此示例文件或保留作为参考